<!DOCTYPE html>
<html>
    <head>
        <title>bim chat app</title>
        <meta charset="UTF-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>

        <script src="/socket.io/socket.io.js"></script>

        <link rel="stylesheet" href="styles/styles.css"></style>
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    </head>
    <body>

      <div class="promptContainer">
        <div class="prompt">will you be remembered by others when you die?</div>
      </div>

      <div class="messagesContainer">
        <!-- <h1>messages</h1> -->
      </div>



      <form class="textForm" action="" method="get">
        <div class="textarea-container">
          <textarea class="newTA" autofocus name="inMess" placeholder="type something" id="" rows="1"></textarea>
          <!-- <textarea autofocus class="inputMessage" placeholder="type something"></textarea> -->
          <!-- <div class="textarea-size"></div> -->
        </div>
        <button type="button" class="sendButton" disabled></button>
      </form>



      <script>

        // inits
        var messages = document.querySelector('.messagesContainer'),
            inputMessage = document.querySelector('.inputMessage'),
            sendButton = document.querySelector('.sendButton');

        var promptContainer = document.querySelector('.promptContainer');
        var prompt = document.querySelector('.prompt');
        var textForm = document.querySelector('.textForm');



        // socket io
        var socket = io.connect(window.location.origin);
        // var socket = io.connect('/');

        socket.on('connect', function() {
            //  console.log('connected to server socket');

            // initialize chats
            console.log(socket.id); // custom color messages
         });

        socket.on('response', function (data) {
          console.log(data);
        });

        socket.on('post', function (data) {
          post(data);
        });

        socket.on('prompt', function (data) {
          console.log(data);
          changePrompt(data);
        });



        // text container magic
        var textContainer, textareaSize;
        var tempH;
        var TALineHeight;
        var post;
        var autoSize = function () {
          // textareaSize.innerHTML = textarea.value + '\n';
          if (textarea.value == "") {
            textarea.rows = 1;
          }
          else {
            tempH = textarea.scrollHeight / TALineHeight; // simple math dividing height of text area by it's line height defined in css as 20px to get number of rows typed
            // console.log(tempH);

            if (tempH == 2) {
              textarea.rows = 2;
            }
            else if (tempH >= 3 ) {
              textarea.rows = 3;
            }
            else {
              textarea.rows = 1; // default to 1 line height
            }
          }

          otherHeights = promptContainer.offsetHeight + 'px - ' + getComputedStyle(textForm).getPropertyValue('margin-top') + ' - ' + getComputedStyle(textForm).getPropertyValue('margin-bottom') + ' - ' + textForm.offsetHeight + 'px' ;
          messages.style.height = 'calc(100vh - ' + otherHeights + ')';

        };
        document.addEventListener('DOMContentLoaded', function() {
          textContainer = document.querySelector('.textarea-container');
          // textareaSize = textContainer.querySelector('.textarea-size');
          // textarea = textContainer.querySelector('textarea');
          textarea = textContainer.querySelector('.newTA');
          TALineHeight = parseInt( window.getComputedStyle(textarea)["line-height"] );



          // fake form because submiting caused a weird reload
          sendButton.addEventListener('click', function(e) {
            e.preventDefault();
            submitMessage();
            return false;
          });



          // submit message on enter key
          textarea.addEventListener('keypress', function(e) {
            if (e.keyCode == 13 && !e.shiftKey) {
              e.preventDefault();
              submitMessage();
              return false;
            }
          });



          // changes the send button color/state
          function checkSendState() {
            if (textarea.value == '') {
              sendButton.disabled = true;
              // textarea.rows = 1;
            }
            else sendButton.disabled = false;
          }
          // listener for send button color/state
          textarea.addEventListener('input', function(e) {
            checkSendState();
          });



          // submit the form message
          function submitMessage() {
            // e.preventDefault()
            // quick validation
            if ( textarea.value != '' ) {
              socket.emit('message', textarea.value);
            }
          }



          // post message to container
          post = function (data) {
            let message = document.createElement('div');
            message.className = 'message wordwrap';
            message.innerHTML = data;
            messages.appendChild(message);
            textarea.value = '';
            textarea.rows = 1;

            // resets
            autoSize();
            checkSendState();
            textarea.focus();
          }



          // change the prompt for all users
          changePrompt = function (data) {

            if ( data == '1' ) {
              prompt.innerText = 'this is the first question';
            }
            else if ( data == '2' ) {
              prompt.innerText = 'this is the second question';
            }
            else if ( data == 'clear' ) {
              messages.innerHTML = '';
            }

            // resets
            textarea.value = '';
            textarea.rows = 1;
            autoSize();
            checkSendState();
            textarea.focus();
          }



          var otherHeights;
          window.addEventListener('resize', function() {
            autoSize();
            // otherHeights = promptContainer.offsetHeight + 'px - ' + getComputedStyle(textForm).getPropertyValue('margin-top') + ' - ' + getComputedStyle(textForm).getPropertyValue('margin-bottom') + ' - ' + textForm.offsetHeight + 'px' ;
            // messages.style.height = 'calc(100vh - ' + otherHeights + ')';
          });



          // do once on start
          autoSize();
          textarea.addEventListener('input', autoSize);
          textarea.focus();
        });








        // document.documentElement.style.setProperty(`--user-color`, 'red');

      </script>
    </body>
</html>
